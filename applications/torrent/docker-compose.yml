services:
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Etc/UTC
      WEBUI_PORT: 8080
      TORRENTING_PORT: 6881
      DOCKER_MODS: ghcr.io/gabe565/linuxserver-mod-vuetorrent
      QBIT_INTERFACE: ${QBITTORRENT_NETWORK_INTERFACE:-eth0}
    labels:
      homepage.group: Indexers
      homepage.name: qBittorrent
      homepage.icon: qbittorrent.png
      homepage.description: Torrent client
      homepage.href: http://qbittorrent.lab
      homepage.weight: 1
      homepage.widget.type: qbittorrent
      homepage.widget.url: http://qbittorrent:8080
      homepage.widget.username: "admin"
      homepage.widget.password: "${QBITTORRENT_PASSWORD}"
      # traefik.enable: true
      # traefik.http.routers.qbittorrent.rule: Host(`qbittorrent.lab`)
      # traefik.http.routers.qbittorrent.entrypoints: web
      # traefik.http.services.qbittorrent.loadbalancer.server.port: 8080
    volumes:
      - qbittorrent-config:/config
      - qbittorrent-downloads:/downloads #optional
    # ports:
    #   # - 8085:8080
    #   - 6881:6881
    #   - 6881:6881/udp
    restart: unless-stopped
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    # networks:
    #   traefik-network: {}
    #   wg: {}

  qbittorrent-init:
    image: python:3.9-alpine
    container_name: qbittorrent-init
    volumes:
      - qbittorrent-config:/config
    environment:
      QBITTORRENT_USERNAME: "${QBITTORRENT_USERNAME:-admin}"
      QBITTORRENT_PASSWORD: "${QBITTORRENT_PASSWORD}"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        
        echo "=== qBittorrent Init Container ==="
        
        CONFIG_FILE="/config/qBittorrent/qBittorrent.conf"
        
        # Wait for config file to be created
        echo "Waiting for config file to be generated..."
        for i in $$(seq 1 60); do
          if [ -f "$$CONFIG_FILE" ]; then
            echo "Config file found!"
            break
          fi
          echo "Waiting... ($$i/60)"
          sleep 2
        done
        
        if [ ! -f "$$CONFIG_FILE" ]; then
          echo "ERROR: Config file was not created after 120 seconds"
          exit 1
        fi

        # Give it a moment to fully write the config
        echo "Waiting a few more seconds to ensure config is ready..."
        sleep 5

        echo "Customizing qBittorrent configuration..."
        
        # Generate password hash
        if [ -z "$$QBITTORRENT_PASSWORD" ]; then
          echo "ERROR: QBITTORRENT_PASSWORD not set"
          exit 1
        fi
        
        echo "Generating password hash..."
        PASSWORD_HASH=$$(python3 <<'PYSCRIPT'
        import hashlib
        import os
        import base64
        
        password = os.environ['QBITTORRENT_PASSWORD']
        salt = os.urandom(16)
        iterations = 100000
        
        dk = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt, iterations)
        
        # Base64 encode the salt and hash
        encoded_salt = base64.b64encode(salt).decode()
        encoded_hash = base64.b64encode(dk).decode()

        # Format for qBittorrent
        qbittorrent_hash = f'@ByteArray({encoded_salt}:{encoded_hash})'

        print(qbittorrent_hash)
        PYSCRIPT
        )
        
        USERNAME="$${QBITTORRENT_USERNAME:-admin}"
        
        echo "Modifying config file with sed..."
        
        # Backup original
        cp "$$CONFIG_FILE" "$${CONFIG_FILE}.backup"
        
        # Use sed to modify existing config
        # Remove existing WebUI username/password if present
        echo "Removing existing WebUI username/password if present..."
        sed -i '/^WebUI\\Username=/d' "$$CONFIG_FILE"
        sed -i '/^WebUI\\Password_PBKDF2=/d' "$$CONFIG_FILE"
        
        # Add/modify WebUI settings in [Preferences] section
        if grep -q '^\[Preferences\]' "$$CONFIG_FILE"; then
          echo "Modifying existing [Preferences] section..."
          # Insert after [Preferences] line
          sed -i "/^\[Preferences\]/a WebUI\\\\Username=$$USERNAME" "$$CONFIG_FILE"
          sed -i "/^WebUI\\\\Username=/a WebUI\\\\Password_PBKDF2=\"$$PASSWORD_HASH\"" "$$CONFIG_FILE"
        else
          echo "Creating [Preferences] section..."
          # Create [Preferences] section if it doesn't exist
          echo "" >> "$$CONFIG_FILE"
          echo "[Preferences]" >> "$$CONFIG_FILE"
          echo "WebUI\\Username=$$USERNAME" >> "$$CONFIG_FILE"
          echo "WebUI\\Password_PBKDF2=\"$$PASSWORD_HASH\"" >> "$$CONFIG_FILE"
        fi
         
        echo "qBittorrent configuration updated successfully."
        echo "Confirming config"
        cat $$CONFIG_FILE

    restart: "no"

  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      VPN_SERVICE_PROVIDER: protonvpn
      VPN_TYPE: wireguard
      # From Proton config
      WIREGUARD_PRIVATE_KEY: ${WIREGUARD_PRIVATE_KEY}
      # Required by Proton
      PROTONVPN_USERNAME: ${PROTON_USERNAME}
      PROTONVPN_PASSWORD: ${PROTON_PASSWORD}
      # Strongly recommended
      FIREWALL: on
      SERVER_COUNTRIES: Albania
    networks:
      - traefik-network
    ports:
      - "8085:8080"   # qBittorrent UI
      - "8000:8000"   # Gluetun UI
    labels:
      homepage.group: Network
      homepage.name: gluetun
      homepage.icon: gluetun.png
      homepage.description: VPN Client
      homepage.href: http://gluetun.lab
      homepage.weight: 2
      homepage.widget.type: gluetun
      homepage.widget.url: http://gluetun:8080
      traefik.enable: true
      traefik.http.routers.gluetun.rule: Host(`gluetun.lab`)
      traefik.http.routers.gluetun.entrypoints: web
      traefik.http.services.gluetun.loadbalancer.server.port: 8000
      traefik.http.routers.qbittorrent.rule: Host(`qbittorrent.lab`)
      traefik.http.routers.qbittorrent.entrypoints: web
      traefik.http.services.qbittorrent.loadbalancer.server.port: 8085

networks:
  traefik-network:
    external: true

volumes:
  qbittorrent-config:
  qbittorrent-downloads: