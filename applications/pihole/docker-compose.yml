services:

  code-fetch:
    container_name: code-fetch
    image: alpine/git:latest
    volumes:
      - /home/ciaran/git/:/git/:rw
    environment:
      GIT_REPO: 'https://github.com/CiaranMcAndrew/homelab.git'
      GIT_BRANCH: 'main'
      SLEEP_INTERVAL: '300'
    entrypoint: ['/bin/sh', '-c']
    command: >
      "
        set -e;
        if [ ! -d /git/homelab/.git ]; then
          echo 'Cloning repository...';
          git clone --branch \"$$GIT_BRANCH\" \"$$GIT_REPO\" /git/homelab;
        fi;
        cd /git/homelab;
        while true; do
          echo 'Pulling latest changes...';
          git pull origin \"$$GIT_BRANCH\";
          sleep $$SLEEP_INTERVAL;
        done
      "
    healthcheck:
      test: ["CMD-SHELL", "test -d /git/homelab/.git"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "80:80/tcp"
      - "443:443/tcp"
    environment:
      TZ: 'Europe/London'
      PIHOLE_DNS_: '1.1.1.1;1.0.0.1'
      DNSMASQ_LISTENING: 'all'
    network_mode: "host"
    volumes:
      # Mount custom configuration files
      - /home/ciaran/git/homelab/applications/pihole/config/:/etc/pihole:ro
      # Persist runtime data
      - './data/pihole:/etc/pihole'
      - './data/dnsmasq.d:/etc/dnsmasq.d'
    cap_add:
      - NET_ADMIN
    depends_on:
      code-fetch:
        condition: service_healthy
    restart: unless-stopped
    dns:
      - 127.0.0.1
      - 1.1.1.1

volumes:
  git-data: