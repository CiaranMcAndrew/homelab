services:

  code-fetch:
    container_name: code-fetch
    image: alpine/git:latest
    volumes:
      - /home/ciaran/git/:/git/:rw
      - 'pihole-data:/etc/pihole'
      - 'homepage-data:/etc/homepage'
      - jellyfin-data:/etc/jellyfin 
    environment:
      GIT_REPO: 'https://github.com/CiaranMcAndrew/homelab.git'
      GIT_BRANCH: 'main'
      SLEEP_INTERVAL: '300'
    entrypoint: ['/bin/sh', '-c']
    command: >
      "
        set -e;
        if [ ! -d /git/homelab/.git ]; then
          echo 'Cloning repository...';
          git clone --branch \"$$GIT_BRANCH\" \"$$GIT_REPO\" /git/homelab;
        fi;
        cd /git/homelab;
        while true; do
          echo 'Pulling latest changes...';
          git pull origin \"$$GIT_BRANCH\";

          echo 'Copying pihole configuration data...';

          # Base paths
          GIT_DIR="/git/homelab/applications/pihole/config"
          PIHOLE_DIR="/etc/pihole"

          # List of files (without .list extension)
          for list in custom adlists; do
              src=\"$$GIT_DIR/$$list.list\"
              dst=\"$$PIHOLE_DIR/$$list.list\"
              echo \"Copying $$src to $$dst\"

              # Check if the file exists in git repo
              if [ -f \"$$src\" ]; then
                  echo \"Copying $$src -> $$dst\"
                  cp -v \"$$src\" \"$$dst\"

                  # Ensure Pi-hole can read/write
                  chown 1000:1000 \"$$dst\"
                  chmod 644 \"$$dst\"
              else
                  echo \"Warning: $$src does not exist, skipping\"
              fi
          done

          echo 'Copying homepage configuration data...';
          cp -vr /git/homelab/applications/homepage/config/* /etc/homepage/

          echo 'Copying Jellyfin data...';
          cp -vr /git/homelab/applications/media/jellyfin/* /etc/jellyfin/

          echo 'Sleeping for $$SLEEP_INTERVAL seconds...';
          sleep $$SLEEP_INTERVAL;        
        done
        
      "
    healthcheck:
      test: ["CMD-SHELL", "test -d /git/homelab/.git"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  traefik:
    image: ghcr.io/traefik/traefik:3.6
    container_name: traefik
    restart: always
    environment:
      - LETS_ENCRYPT_EMAIL=${LETS_ENCRYPT_EMAIL}
    command:
      - --ping=true
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      # - --certificatesresolvers.myresolver.acme.dnschallenge=${DNS_CHALLENGE:-false}
      # - --certificatesresolvers.myresolver.acme.dnschallenge.provider=${DNS_CHALLENGE_PROVIDER:-cloudflare}
      # - --certificatesresolvers.myresolver.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      # - --certificatesresolvers.myresolver.acme.caserver=${LETS_ENCRYPT_CA_SERVER:-https://acme-v02.api.letsencrypt.org/directory}
      # - --certificatesresolvers.myresolver.acme.email=${LETS_ENCRYPT_EMAIL}
      # - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
    labels:
      # Dashboard routing
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.lab`)"
      - "traefik.http.routers.dashboard.entrypoints=web"
      # - "traefik.http.routers.dashboard.tls=true"
      # - "traefik.http.routers.dashboard.tls.certresolver=myresolver"
      - "traefik.http.routers.dashboard.service=api@internal"

      # Homepage 
      - homepage.group=Network
      - homepage.name=Traefik
      - homepage.icon=traefik.png
      - homepage.href=http://traefik.lab
      - homepage.description=Reverse proxy and load balancer
      - homepage.weight=0
      - homepage.widget.type=traefik
      - homepage.widget.url=http://traefik.lab
    networks:
      - traefik-network
      - portainer_net
    ports:
      - "80:80"
      - "8080:8080"
      - "443:443"
    volumes:
      - letsencrypt-data:/letsencrypt
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    extra_hosts:
      - host.docker.internal:172.17.0.1
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 1m
      retries: 10

  traefik-transport:
    image: gcr.io/google_containers/pause:latest
    container_name: traefik_transport
    labels:
      traefik.enable: "false"
      traefik.http.serverstransports.internal-https.insecureskipverify: "true"
    networks:
      - traefik-network


  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    labels:
      traefik.enable: true
      traefik.http.routers.pihole.rule: Host(`pihole.lab`)
      traefik.http.routers.pihole.entrypoints: web
      traefik.http.services.pihole.loadbalancer.server.url: http://host.docker.internal:8081

      # Homepage 
      homepage.group: Network
      homepage.name: Pi-hole
      homepage.icon: pi-hole.png
      homepage.href: http://pihole.lab/admin
      homepage.description: Network wide ad-blocking via Pi-hole
      homepage.weight: 0
      homepage.widget.type: pihole
      homepage.widget.version: 6
      homepage.widget.url: http://pihole.lab
      homepage.widget.key: ${PIHOLE_WEBPASSWORD}
    environment:
      TZ: 'Europe/London'
      PIHOLE_DNS_: '1.1.1.1;1.0.0.1'
      DNSMASQ_LISTENING: 'all'
      FTLCONF_webserver_port: '8081,[::]:8081,8444os,[::]:8444os'
    network_mode: "host"
    volumes:
      - 'pihole-data:/etc/pihole'
      - ${GIT_DATA_DIR}/dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    depends_on:
      code-fetch:
        condition: service_healthy
    restart: unless-stopped
    dns:
      - 127.0.0.1
      - 1.1.1.1

volumes:
  git-data:
    name: git-data
  pihole-data:
    name: pihole-data
  letsencrypt-data:
    name: letsencrypt-data
  homepage-data:
    name: homepage-data
  jellyfin-data:
    name: jellyfin-data

networks:
  default:
    name: pihole_network
  traefik-network:
    name: traefik-network
  portainer_net:
    external: true
    name: portainer_portainer_net