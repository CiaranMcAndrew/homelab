services:

  code-fetch:
    container_name: code-fetch
    image: alpine/git:latest
    volumes:
      - /home/ciaran/git/:/git/:rw
      - 'pihole-data:/etc/pihole'
    environment:
      GIT_REPO: 'https://github.com/CiaranMcAndrew/homelab.git'
      GIT_BRANCH: 'main'
      SLEEP_INTERVAL: '300'
    entrypoint: ['/bin/sh', '-c']
    command: >
      "
        set -e;
        if [ ! -d /git/homelab/.git ]; then
          echo 'Cloning repository...';
          git clone --branch \"$$GIT_BRANCH\" \"$$GIT_REPO\" /git/homelab;
        fi;
        cd /git/homelab;
        while true; do
          echo 'Pulling latest changes...';
          git pull origin \"$$GIT_BRANCH\";
          sleep $$SLEEP_INTERVAL;
        done
        
        echo "Copying pihole configuration data...";
        cp -r /git/homelab/applications/pihole/config/* /etc/pihole/;
      "
    healthcheck:
      test: ["CMD-SHELL", "test -d /git/homelab/.git"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped


  # pihole-init:
  #   image: alpine:latest
  #   container_name: pihole-init
  #   depends_on:
  #     code-fetch:
  #       condition: service_healthy
  #   volumes:
  #     - /home/ciaran/git/:/git/:rw
  #     - 'pihole-data:/etc/pihole'
  #   entrypoint: ["/bin/sh", "-c"]
  #   command: >
  #     "
  #       set -e;
  #       echo "Copying pihole configuration data...";
  #       cp -r /git/homelab/applications/pihole/config/* /etc/pihole/;
  #     "
  #   restart: "no"

  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "80:80/tcp"
      - "443:443/tcp"
    environment:
      TZ: 'Europe/London'
      PIHOLE_DNS_: '1.1.1.1;1.0.0.1'
      DNSMASQ_LISTENING: 'all'
    network_mode: "host"
    volumes:
      # Mount custom configuration files
      # # - /home/ciaran/git/homelab/applications/pihole/config/:/etc/pihole:ro
      # - ${CONFIG_DIR}/custom.list:/etc/pihole/custom.list:ro
      # - ${CONFIG_DIR}/adlists.list:/etc/pihole/adlists.list:ro
      # - ${CONFIG_DIR}/whitelist.txt:/etc/whitelist.txt:ro
      # - ${CONFIG_DIR}/blacklist.txt:/etc/blacklist.txt:ro 
      # - ${CONFIG_DIR}/regex.list:/etc/pihole/regex.list:ro 
      # - ${CONFIG_DIR}/05-custom.conf:/etc/dnsmasq.d/05-custom.conf:ro
      # Persist runtime data
      - 'pihole-data:/etc/pihole'
      - ${GIT_DATA_DIR}/dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    depends_on:
      pihole-init:
        condition: service_healthy
    restart: unless-stopped
    dns:
      - 127.0.0.1
      - 1.1.1.1

volumes:
  git-data:
  pihole-data: