# disable-systemd-resolved.yml
---
- name: Disable systemd-resolved to free port 53 for Pi-hole
  hosts: "{{ hosts | default('docker_hosts') }}"
  become: yes
  
  tasks:
    - name: Check if port 53 is in use
      shell: ss -tulpn | grep ':53 '
      register: port_check
      changed_when: false
      failed_when: false

    - name: Display what's using port 53
      debug:
        msg: "Port 53 is currently used by: {{ port_check.stdout_lines }}"
      when: port_check.stdout != ""

    - name: Check if systemd-resolved is running
      systemd:
        name: systemd-resolved
      register: resolved_status
      failed_when: false

    - name: Stop systemd-resolved
      systemd:
        name: systemd-resolved
        state: stopped
      when: resolved_status.status.ActiveState == "active"

    - name: Disable systemd-resolved
      systemd:
        name: systemd-resolved
        enabled: no
      when: resolved_status.status is defined

    - name: Check if /etc/resolv.conf is a symlink to systemd-resolved
      stat:
        path: /etc/resolv.conf
      register: resolv_conf

    - name: Remove systemd-resolved symlink
      file:
        path: /etc/resolv.conf
        state: absent
      when: resolv_conf.stat.islnk is defined and resolv_conf.stat.islnk

    - name: Create new /etc/resolv.conf with upstream DNS
      copy:
        content: |
          # Generated by Ansible for Pi-hole deployment
          nameserver 1.1.1.1
          nameserver 1.0.0.1
          nameserver 8.8.8.8
        dest: /etc/resolv.conf
        mode: '0644'
      when: resolv_conf.stat.islnk is defined and resolv_conf.stat.islnk

    - name: Verify port 53 is now free
      wait_for:
        port: 53
        state: stopped
        timeout: 5
      register: port_free
      failed_when: false

    - name: Confirm port 53 is available
      shell: ss -tulpn | grep ':53 ' || echo "Port 53 is free"
      register: final_check
      changed_when: false

    - name: Display final port status
      debug:
        msg: "{{ final_check.stdout }}"
